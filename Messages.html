<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
		
		<title>Messages</title>
		
		<script type="text/javascript" btkid="btk::btk" src="lib/btk/btk.js"></script>
		
		<script type="text/javascript" btkid="common::package" src="scripts/common/package.js"></script>
		
		<script type="text/javascript" btkid="page::alarm.messages">
			btk.define({
				name: 'alarms@page',
				load: true,
				libs: {
					base: 'base@common',
					Log: 'log@wtk'
				},
				css : ['scroll-plain@wtk'],
				when: [ 'state::page.loaded' ],
				init: function(libs, exports) {
				
					var link = page.link;
					var Log  = libs.Log;
					
					var output = new Log();
					var view = output.create();
					var wrap = document.getElementById('wrap');
					
					wrap.appendChild(view);
					
					var scrolling = false;
	
					//scroll the log
					function doScroll() {
						wrap.scrollTop = wrap.scrollHeight - wrap.clientHeight;
						scrolling = false;
					}
					
					function scroll() {
						if (scrolling) { return; }
						
						scrolling = true;
						// deferred so that a sequence of appends within a
						// single execution unit causes a single scroll
						// if not deferred then var scrolling gets repeatedly toggled
						btk.defer({}, doScroll, []);
					}

					output.onappend = scroll;
					
					var message = link.alarms.message;
					
					message.apply(function(line) {
						output.log(line);
					});
					
					link.alarms.port.open(
						function(msg) {
							output.log(msg);
						}
					);
					
					exports.clear = function() {
						output.clear();
						message.clear();
					};
				}
			});
		</script>
		
		<style type="text/css">
			body {
				background-color: #ffcccc;
				margin: 0.5em;
			}
			
			.wrap {
				overflow: auto;
				border-width: 1px;
				border-style: solid;
				border-color: black;
				background-color: #dddddd;
				padding: 0.5em;
			}
		</style>
		
	</head>
	<body class="fill">
		<table class="layout"><tbody>
			<tr class="row middle"><td style="position: relative;">
				<div id="wrap" class="wrap fill scroll-plain"></div>
			</td></tr>
			<tr class="row bottom"><td>
				<button onclick="btk.require('alarms@page').clear();">Clear</button>
			</td></tr>
		</tbody></table>
	</body>
</html>
